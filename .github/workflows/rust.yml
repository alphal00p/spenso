name: Rust

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build dependencies first - this creates the base cache for all other jobs
  build-deps:
    environment: symbolica_keys
    runs-on: ubuntu-latest
    env:
      SYMBOLICA_LICENSE: ${{ secrets.SYMBOLICA_LICENSE }}
    outputs:
      deps-built: ${{ steps.build-deps.outputs.deps-built }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: lcnbr
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7
      - name: Build dependencies
        id: build-deps
        run: |
          # Build just the dependencies to populate the cache
          nix build .#packages.x86_64-linux.workspace --impure --no-link
          echo "deps-built=true" >> $GITHUB_OUTPUT

  # Run all checks per-crate
  checks:
    environment: symbolica_keys
    runs-on: ubuntu-latest
    needs: build-deps
    env:
      SYMBOLICA_LICENSE: ${{ secrets.SYMBOLICA_LICENSE }}
    strategy:
      fail-fast: false
      matrix:
        check:
          # Individual crate checks only
          - spenso-clippy
          - spenso-doc
          - spenso-nextest
          - spenso-tarpaulin
          - spenso-macros-clippy
          - spenso-macros-doc
          - spenso-macros-nextest
          - spenso-macros-tarpaulin
          - spenso-hep-lib-clippy
          - spenso-hep-lib-doc
          - spenso-hep-lib-nextest
          - spenso-hep-lib-tarpaulin
          - idenso-clippy
          - idenso-doc
          - idenso-nextest
          - idenso-tarpaulin
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: lcnbr
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7
      - name: Run ${{ matrix.check }}
        run: nix build .#checks.x86_64-linux.${{ matrix.check }} --impure --no-link

  # Test with different feature combinations per-crate
  feature-tests:
    environment: symbolica_keys
    runs-on: ubuntu-latest
    needs: build-deps
    env:
      SYMBOLICA_LICENSE: ${{ secrets.SYMBOLICA_LICENSE }}
    strategy:
      fail-fast: false
      matrix:
        check:
          # Individual crate feature checks
          - spenso-clippy-shadowing
          - spenso-nextest-shadowing
          - spenso-tarpaulin-shadowing
          - idenso-clippy-bincode
          - idenso-nextest-bincode
          - idenso-tarpaulin-bincode
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: lcnbr
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7
      - name: Run ${{ matrix.check }}
        run: nix build .#checks.x86_64-linux.${{ matrix.check }} --impure --no-link

  # Coverage runs separately since it's slower and produces artifacts
  coverage:
    environment: symbolica_keys
    runs-on: ubuntu-latest
    needs: build-deps
    env:
      SYMBOLICA_LICENSE: ${{ secrets.SYMBOLICA_LICENSE }}
    strategy:
      fail-fast: false
      matrix:
        crate:
          - spenso
          - spenso-macros
          - spenso-hep-lib
          - idenso
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: lcnbr
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7
      - name: Run tarpaulin coverage for ${{ matrix.crate }}
        run: nix build .#checks.x86_64-linux.${{ matrix.crate }}-tarpaulin --impure
      - name: Upload to codecov.io
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          file: ./result/cobertura.xml
          fail_ci_if_error: true

  # Optional: Build the actual packages to ensure they work
  build:
    environment: symbolica_keys
    runs-on: ubuntu-latest
    needs: [build-deps, checks, feature-tests, coverage]
    env:
      SYMBOLICA_LICENSE: ${{ secrets.SYMBOLICA_LICENSE }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nix
        uses: cachix/install-nix-action@v27
      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: lcnbr
          authToken: "${{ secrets.CACHIX_AUTH_TOKEN }}"
      - name: Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v7
      - name: Build workspace
        run: nix build .#packages.x86_64-linux.workspace --impure --no-link
